
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Design &#8212; treereduce  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Overview" href="overview.html" />
    <link rel="prev" title="Changelog" href="changelog.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">treereduce  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  User Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="contributing.html">
   Contributing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="install.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="usage.html">
   Usage
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="benchmarks.html">
   Benchmarks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="changelog.html">
   Changelog
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Design
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="overview.html">
   Overview
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developer Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="build.html">
   Build
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dev.html">
   Development
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/design.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#goals">
   Goals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-statement">
   Design Statement
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#assumptions">
   Assumptions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-level-design">
   High-Level Design
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reduction-strategies">
   Reduction Strategies
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pseudocode">
   Pseudocode
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bibliography">
   Bibliography
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Design</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#goals">
   Goals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-statement">
   Design Statement
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#assumptions">
   Assumptions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-level-design">
   High-Level Design
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reduction-strategies">
   Reduction Strategies
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pseudocode">
   Pseudocode
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bibliography">
   Bibliography
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="section" id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this headline">#</a></h1>
<div class="section" id="goals">
<span id="algorithm-goals"></span><h2>Goals<a class="headerlink" href="#goals" title="Permalink to this headline">#</a></h2>
<p>The core reduction algorithm has three goals:</p>
<ol class="arabic simple">
<li><p>Go fast</p></li>
<li><p>Produce small test cases</p></li>
<li><p>Produce readable test cases</p></li>
</ol>
<p>Unlike more theoretical work in this space, the algorithm does <em>not</em> attempt to
minimize the number of “oracle queries”, that is, invocations of the
user-provided “interestingness test”.</p>
</div>
<div class="section" id="design-statement">
<h2>Design Statement<a class="headerlink" href="#design-statement" title="Permalink to this headline">#</a></h2>
<p>The aims of <code class="docutils literal notranslate"><span class="pre">treereduce</span></code> are more pragmatic than academic. It is based on
similar principles to those discussed in the <a class="reference external" href="https://lcamtuf.coredump.cx/afl/technical_details.txt">AFL whitepaper</a>:</p>
<blockquote>
<div><p>[treereduce] does its best not to focus on any singular principle of operation
and not be a proof-of-concept for any specific theory. […] The only true
governing principles are speed, reliability, and ease of use.</p>
</div></blockquote>
</div>
<div class="section" id="assumptions">
<span id="algorithm-assumptions"></span><h2>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this headline">#</a></h2>
<p>These assumptions strongly inform the algorithm design:</p>
<ol class="arabic simple">
<li><p>The interestingness will be comparatively slow—it will generally involve
spinning up a new process, disk I/O, parsing, type-checking, etc.</p></li>
<li><p>Smaller inputs lead to faster interestingness tests.</p></li>
</ol>
<p>These assumptions hold for the use-case of reducing programs that cause compiler
crashes.</p>
</div>
<div class="section" id="high-level-design">
<h2>High-Level Design<a class="headerlink" href="#high-level-design" title="Permalink to this headline">#</a></h2>
<p>Due to <a class="reference internal" href="#algorithm-assumptions"><span class="std std-ref">Assumption (1)</span></a>, it’s essential that <code class="docutils literal notranslate"><span class="pre">treereduce</span></code>
execute several interestingness tests in parallel. Luckily, for the same reason,
lock contention is unlikely to be a major issue—so long as executing the
interestingness test doesn’t require holding a lock, most threads will spend the
majority of their time executing the interestingness test, rather than waiting
for locks on shared data.</p>
<p>The recent paper “<a class="reference external" href="https://github.com/golnazgh/PARDIS">PARDIS</a> : Priority Aware Test Case Reduction”
highlights the importance of <em>prioritization</em> of reductions. Greedy removal of
the <em>largest</em> subtrees leads to greatly increased performance due to faster
interestingness tests (<a class="reference internal" href="#algorithm-assumptions"><span class="std std-ref">Assumption (2)</span></a>).</p>
<p>With these ideas in mind, the overall algorithm design involves spinning up some
number of threads, which share three pieces of data:</p>
<ol class="arabic simple">
<li><p>The original text and syntax tree of the target (read-only)</p></li>
<li><p>A prioritized max-heap of <a class="reference internal" href="#reduction-strategies"><span class="std std-ref"><em>reduction tasks</em></span></a>
(read-write)</p></li>
<li><p>A set of <em>edits</em> to the syntax tree (read-write)</p></li>
</ol>
<p>where an edit is either the deletion of a subtree, or a replacement of one
subtree by another. Each thread executes the following loop:</p>
<ol class="arabic simple">
<li><p>Pop a reduction task off the heap.</p></li>
<li><p>Create a local copy of the edits. Add edits according to the current task.</p></li>
<li><p>Execute the interestingness test on the reduced program, i.e., the target
as altered by the local set of edits.</p></li>
<li><p>If the reduced program was still interesting, try replacing the global edits.
If the global edits were changed by another thread, try this task again with
the new edits, that is, go to (2).</p></li>
<li><p>Push any new tasks onto the task queue.</p></li>
<li><p>Go to (1).</p></li>
</ol>
<p>If lock contention does become an issue, it may be beneficial for each thread to
maintain a local task heap in addition to the global one, or even to attempt
multiple tasks before replacing the global edits.</p>
</div>
<div class="section" id="reduction-strategies">
<span id="id1"></span><h2>Reduction Strategies<a class="headerlink" href="#reduction-strategies" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">treereduce</span></code> uses several strategies during program minimization:</p>
<ul class="simple">
<li><p><em>Deletion</em> (TODO(<a class="reference external" href="https://github.com/langston-barrett/treereduce/issues/1">#1</a>)): When a child is optional, <code class="docutils literal notranslate"><span class="pre">treereduce</span></code> attempts to
delete it. For example, <code class="docutils literal notranslate"><span class="pre">treereduce</span></code> might delete the <code class="docutils literal notranslate"><span class="pre">const</span></code> in <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">int</span> <span class="pre">x;</span></code>.</p></li>
<li><p><em>Delta debugging</em> (TODO(<a class="reference external" href="https://github.com/langston-barrett/treereduce/issues/2">#2</a>)): When a node has a list of children,
<code class="docutils literal notranslate"><span class="pre">treereduce</span></code> uses <em>delta debugging</em> to delete as many as possible in an efficient
way.</p></li>
<li><p><em>Hoisting</em> (TODO(<a class="reference external" href="https://github.com/langston-barrett/treereduce/issues/3">#3</a>)): Nodes with a recursive structure may be replaced
by their descendants, e.g. replacing <code class="docutils literal notranslate"><span class="pre">5</span> <span class="pre">+</span> <span class="pre">(3</span> <span class="pre">*</span> <span class="pre">y)</span></code> with just <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p></li>
</ul>
</div>
<div class="section" id="pseudocode">
<h2>Pseudocode<a class="headerlink" href="#pseudocode" title="Permalink to this headline">#</a></h2>
<p>A few notes:</p>
<ul class="simple">
<li><p>In practice, <code class="docutils literal notranslate"><span class="pre">weight</span></code> is simply the number of bytes in the source text of the
node.</p></li>
</ul>
<p>TODO(lb): This is not current/complete.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NodeId</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="o">...</span>  <span class="c1"># defined in tree-sitter</span>

    <span class="k">def</span> <span class="nf">is_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">is_optional</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="o">...</span>

<span class="k">class</span> <span class="nc">Heap</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Tree</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tree</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">root_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="o">...</span>

<span class="n">enum</span> <span class="n">Task</span><span class="p">:</span>
    <span class="n">Explore</span><span class="p">(</span><span class="n">NodeId</span><span class="p">)</span>
    <span class="n">Delete</span><span class="p">(</span><span class="n">NodeId</span><span class="p">)</span>
    <span class="n">Hoist</span><span class="p">(</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">NodeId</span><span class="p">)</span>
    <span class="n">Delta</span><span class="p">(</span><span class="n">NodeId</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PrioritizedTask</span><span class="p">:</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Task</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">Target</span><span class="p">:</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">Text</span>

<span class="k">class</span> <span class="nc">Ctx</span><span class="p">:</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Target</span>
    <span class="n">heap</span><span class="p">:</span> <span class="n">RwLock</span><span class="p">[</span><span class="n">Heap</span><span class="p">]</span>
    <span class="n">edits</span><span class="p">:</span> <span class="n">RwLock</span><span class="p">[</span><span class="n">Edits</span><span class="p">]</span>
    <span class="c1"># TODO(lb): Condition variables?</span>
    <span class="n">threads</span><span class="p">:</span> <span class="n">AtomicUsize</span>
    <span class="n">idle_threads</span><span class="p">:</span> <span class="n">AtomicUsize</span>

<span class="k">def</span> <span class="nf">treereduce</span><span class="p">(</span><span class="n">source_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">source_code</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">source_code</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Ctx</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">RwLock</span><span class="p">(</span><span class="n">Heap</span><span class="p">()),</span> <span class="n">Edits</span><span class="p">())</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_node</span><span class="p">()</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Explore</span><span class="p">(</span><span class="n">NodeId</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">heap</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">PrioritizedTask</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">weight</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="n">AtomicUsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">idle_threads</span> <span class="o">=</span> <span class="n">AtomicUsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fork</span><span class="p">(</span><span class="n">spawn</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">idle_threads</span><span class="p">)</span>

    <span class="c1"># Wait for all threads to finish and exit:</span>
    <span class="k">while</span> <span class="n">tree</span><span class="o">.</span><span class="n">count_references</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">wait</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">tree</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="c1"># -----------------------------------------------------------</span>
<span class="c1"># Parallel structure of the computation</span>

<span class="k">def</span> <span class="nf">spawn</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">:</span> <span class="n">Heap</span><span class="p">,</span> <span class="n">threads</span><span class="p">:</span> <span class="n">AtomicUsize</span><span class="p">,</span> <span class="n">idle_threads</span><span class="p">:</span> <span class="n">AtomicUsize</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">threads</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">idle</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idle</span><span class="p">:</span>
            <span class="n">idle_threads</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">idle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">heap</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="n">match</span> <span class="n">heap</span><span class="o">.</span><span class="n">pop_max</span><span class="p">():</span>
            <span class="n">case</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">heap</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
                <span class="n">idle</span> <span class="o">=</span> <span class="n">idle_logic</span><span class="p">(</span><span class="n">idle_threads</span><span class="p">)</span>
            <span class="n">case</span> <span class="n">task</span><span class="p">:</span>
                <span class="n">heap</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
                <span class="n">dispatch</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">idle_logic</span><span class="p">(</span><span class="n">idle_threads</span><span class="p">:</span> <span class="n">AtomicUSize</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">idle_threads</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">idle_threads</span> <span class="o">==</span> <span class="n">NUM_THREADS</span><span class="p">:</span>
        <span class="n">exit_thread</span><span class="p">()</span>
    <span class="n">sleep</span><span class="p">()</span>  <span class="c1"># some kind of backoff</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># -----------------------------------------------------------</span>
<span class="c1"># Reduction logic</span>

<span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">:</span> <span class="n">Heap</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">match</span> <span class="n">task</span><span class="p">:</span>
        <span class="n">case</span> <span class="n">Explore</span><span class="p">(</span><span class="n">node_id</span><span class="p">):</span>
            <span class="n">explore</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
        <span class="n">case</span> <span class="n">Delete</span><span class="p">(</span><span class="n">node_id</span><span class="p">):</span>
            <span class="n">delete</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
        <span class="n">case</span> <span class="n">Hoist</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Unimplemented&quot;</span> <span class="c1"># TODO(lb)</span>
        <span class="n">case</span> <span class="n">Delta</span><span class="p">(</span><span class="n">node_id</span><span class="p">):</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Unimplemented&quot;</span> <span class="c1"># TODO(lb)</span>

<span class="k">def</span> <span class="nf">explore</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">:</span> <span class="n">Heap</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">heap</span><span class="o">.</span><span class="n">lock</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_optional</span><span class="p">():</span>
            <span class="n">heap</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">PrioritizedTask</span><span class="p">(</span><span class="n">Delete</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">weight</span><span class="p">(</span><span class="n">node</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="n">heap</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">PrioritizedTask</span><span class="p">(</span><span class="n">Explore</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">weight</span><span class="p">(</span><span class="n">child</span><span class="p">))))</span>
        <span class="c1"># TODO(lb): Other tasks</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">heap</span><span class="p">:</span> <span class="n">Heap</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># -----------------------------------------------------------</span>
<span class="c1"># Helpers</span>

<span class="k">def</span> <span class="nf">interesting_replacement</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">variant</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">interesting</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">variant</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">source_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tree</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">exit_thread</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="bibliography">
<span id="bib"></span><h2>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline">#</a></h2>
<p>TODO(#16): BibTeX</p>
<ul class="simple">
<li><p>Gharachorlu, G. and Sumner, N., 2019, April. : Priority Aware Test Case
Reduction. In International Conference on Fundamental Approaches to Software
Engineering (pp. 409-426). Springer, Cham.</p></li>
<li><p>Sun, C., Li, Y., Zhang, Q., Gu, T. and Su, Z., 2018, May. Perses:
Syntax-guided program reduction. In Proceedings of the 40th International
Conference on Software Engineering (pp. 361-371).</p></li>
<li><p>Hodován, R. and Kiss, Á., 2016, July. Practical Improvements to the Minimizing
Delta Debugging Algorithm. In ICSOFT-EA (pp. 241-248).</p></li>
<li><p>Hodován, R. and Kiss, Á., 2016, November. Modernizing hierarchical delta
debugging. In Proceedings of the 7th International Workshop on Automating Test
Case Design, Selection, and Evaluation (pp. 31-37).</p></li>
<li><p>Vince, D., Hodován, R., Bársony, D. and Kiss, Á., 2021, May. Extending
Hierarchical Delta Debugging with Hoisting. In 2021 IEEE/ACM International
Conference on Automation of Software Test (AST) (pp. 60-69). IEEE.</p></li>
<li><p>Kiss, Á., Hodován, R. and Gyimóthy, T., 2018, November. HDDr: a recursive
variant of the hierarchical delta debugging algorithm. In Proceedings of the
9th ACM SIGSOFT International Workshop on Automating TEST Case Design,
Selection, and Evaluation (pp. 16-22).</p></li>
<li><p>Hodován, R., Kiss, Á. and Gyimóthy, T., 2017, September. Coarse hierarchical
delta debugging. In 2017 IEEE international conference on software maintenance
and evolution (ICSME) (pp. 194-203). IEEE.</p></li>
<li><p>https://blog.sigplan.org/2021/03/30/an-overview-of-test-case-reduction/</p></li>
<li><p>https://blog.trailofbits.com/2019/11/11/test-case-reduction/</p></li>
</ul>
</div>
</div>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="changelog.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Changelog</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="overview.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Overview</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Langston Barrett<br/>
  
      &copy; Copyright 2022, Langston Barrett.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>